{% extends "layout.html" %}

{% block title %}Wallet Management{% endblock %}

{% block header %}Wallet Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Create New Wallet</h5>
            </div>
            <div class="card-body">
                <form id="createWalletForm" class="row g-3">
                    <div class="col-md-4">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="col-md-4">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="col-md-4">
                        <label for="initialCurrency" class="form-label">Initial {{ settings.currency_name }}</label>
                        <input type="number" class="form-control" id="initialCurrency" min="0" step="0.01" value="0">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Create Wallet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">All Wallets</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col">Wallet Name</th>
                        <th scope="col">Balance</th>
                        <th scope="col">Status</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="walletsBody">
                    <tr>
                        <td colspan="4" class="text-center">Loading wallets...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadWallets() {
    fetch('/api/get/walletList')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('walletsBody');
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No wallets found</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach(wallet => {
                html += `
                    <tr>
                        <td>${wallet.wallet_name}</td>
                        <td>${wallet.balance} ${wallet.currency}</td>
                        <td>
                            <span class="badge bg-${wallet.is_frozen ? 'danger' : 'success'}">
                                ${wallet.is_frozen ? 'Frozen' : 'Active'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="/admin/wallet/${wallet.wallet_name}" class="btn btn-sm btn-primary">Details</a>
                                <a href="/wallet/${wallet.wallet_name}" class="btn btn-sm btn-outline-secondary">View</a>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('walletsBody').innerHTML = 
                '<tr><td colspan="4" class="text-center text-danger">Error loading wallets</td></tr>';
        });
}

// Create Wallet Form
document.getElementById('createWalletForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const initialCurrency = document.getElementById('initialCurrency').value;
    
    // Show loading state
    Swal.fire({
        title: 'Creating wallet...',
        text: 'Please wait',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetchData('/api/setup/wallet', {
        method: 'POST',
        body: JSON.stringify({
            username: username,
            password: password,
            initial_currency: initialCurrency
        })
    })
    .then(data => {
        if (data.message) {
            Swal.fire({
                title: 'Success!',
                text: data.message,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                // Always refresh the page after a successful action
                location.reload();
            });
        }
    })
    .catch((error) => {
        Swal.fire({
            title: 'Error!',
            text: error.message || 'Failed to create wallet',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    });
});

// Load wallets on page load
window.addEventListener('load', function() {
    loadWallets();
});
</script>
{% endblock %}
