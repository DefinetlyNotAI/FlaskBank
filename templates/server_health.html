{% extends "layout.html" %}

{% block title %}Server Health{% endblock %}

{% block header %}Server Health Monitor{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">System Resources</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">CPU Usage</label>
                        <div class="progress">
                            <div id="cpuProgress" class="progress-bar" role="progressbar" style="width: 0;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Memory Usage</label>
                        <div class="progress">
                            <div id="memoryProgress" class="progress-bar bg-info" role="progressbar" style="width: 0;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Disk Usage</label>
                        <div class="progress">
                            <div id="diskProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                            </div>
                        </div>
                    </div>
                    <div class="small text-muted mt-3">
                        Last updated: <span id="lastUpdated">Never</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Database Status</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Connection Status
                            <span id="dbStatus" class="badge bg-secondary">Unknown</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Users
                            <span id="totalUsers">0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Requests
                            <span id="totalRequests">0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Logs
                            <span id="totalLogs">0</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Server Activity</h5>
                    <button id="refreshBtn" class="btn btn-sm btn-outline-primary">Refresh Data</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Status</th>
                            </tr>
                            </thead>
                            <tbody id="metricsBody">
                            <tr>
                                <td colspan="3" class="text-center">Loading metrics...</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const refreshBtn = document.getElementById('refreshBtn');

            // Load health data on page load and when refresh button is clicked
            loadHealthData();

            refreshBtn.addEventListener('click', function () {
                loadHealthData();
            });

            // Auto-refresh every 30 seconds
            setInterval(loadHealthData, 30000);

            function loadHealthData() {
                fetch('/api/server/health')
                    .then(response => response.json())
                    .then(data => {
                        updateSystemResources(data.system);
                        updateDatabaseStatus(data.database);
                        updateServerActivity(data.metrics);

                        // Update last updated time
                        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to load server health data',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            }

            function updateSystemResources(system) {
                // Update CPU usage
                const cpuProgress = document.getElementById('cpuProgress');
                cpuProgress.style.width = `${system.cpu_percent}%`;
                cpuProgress.setAttribute('aria-valuenow', system.cpu_percent);
                cpuProgress.textContent = `${system.cpu_percent}%`;

                // Set color based on usage
                if (system.cpu_percent > 80) {
                    cpuProgress.classList.remove('bg-info', 'bg-warning', 'bg-success');
                    cpuProgress.classList.add('bg-danger');
                } else if (system.cpu_percent > 50) {
                    cpuProgress.classList.remove('bg-info', 'bg-danger', 'bg-success');
                    cpuProgress.classList.add('bg-warning');
                } else {
                    cpuProgress.classList.remove('bg-warning', 'bg-danger', 'bg-info');
                    cpuProgress.classList.add('bg-success');
                }

                // Update memory usage
                const memoryProgress = document.getElementById('memoryProgress');
                memoryProgress.style.width = `${system.memory_percent}%`;
                memoryProgress.setAttribute('aria-valuenow', system.memory_percent);
                memoryProgress.textContent = `${system.memory_percent}%`;

                // Set color based on usage
                if (system.memory_percent > 80) {
                    memoryProgress.classList.remove('bg-info', 'bg-warning', 'bg-success');
                    memoryProgress.classList.add('bg-danger');
                } else if (system.memory_percent > 50) {
                    memoryProgress.classList.remove('bg-info', 'bg-danger', 'bg-success');
                    memoryProgress.classList.add('bg-warning');
                } else {
                    memoryProgress.classList.remove('bg-warning', 'bg-danger', 'bg-success');
                    memoryProgress.classList.add('bg-info');
                }

                // Update disk usage
                const diskProgress = document.getElementById('diskProgress');
                diskProgress.style.width = `${system.disk_percent}%`;
                diskProgress.setAttribute('aria-valuenow', system.disk_percent);
                diskProgress.textContent = `${system.disk_percent}%`;

                // Set color based on usage
                if (system.disk_percent > 80) {
                    diskProgress.classList.remove('bg-info', 'bg-warning', 'bg-success');
                    diskProgress.classList.add('bg-danger');
                } else if (system.disk_percent > 50) {
                    diskProgress.classList.remove('bg-info', 'bg-danger', 'bg-success');
                    diskProgress.classList.add('bg-warning');
                } else {
                    diskProgress.classList.remove('bg-danger', 'bg-success', 'bg-info');
                    diskProgress.classList.add('bg-warning');
                }
            }

            function updateDatabaseStatus(database) {
                // Update database connection status
                const dbStatus = document.getElementById('dbStatus');
                dbStatus.textContent = database.connected ? 'Connected' : 'Disconnected';
                dbStatus.className = database.connected ? 'badge bg-success' : 'badge bg-danger';

                // Update database metrics
                document.getElementById('totalUsers').textContent = database.total_users;
                document.getElementById('totalRequests').textContent = database.total_requests;
                document.getElementById('totalLogs').textContent = database.total_logs;
            }

            function updateServerActivity(metrics) {
                const metricsBody = document.getElementById('metricsBody');
                metricsBody.innerHTML = '';

                metrics.forEach(metric => {
                    const tr = document.createElement('tr');

                    // Metric name
                    const tdName = document.createElement('td');
                    tdName.textContent = metric.name;
                    tr.appendChild(tdName);

                    // Metric value
                    const tdValue = document.createElement('td');
                    tdValue.textContent = metric.value;
                    tr.appendChild(tdValue);

                    // Metric status
                    const tdStatus = document.createElement('td');
                    const statusBadge = document.createElement('span');
                    statusBadge.className = `badge bg-${metric.status === 'good' ? 'success' : metric.status === 'warning' ? 'warning' : 'danger'}`;
                    statusBadge.textContent = metric.status.charAt(0).toUpperCase() + metric.status.slice(1);
                    tdStatus.appendChild(statusBadge);
                    tr.appendChild(tdStatus);

                    metricsBody.appendChild(tr);
                });
            }
        });
    </script>
{% endblock %}
